<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì—”ë³´ì„ í”Œë˜ë„ˆ í”„ë¡œ - ê´€ë¦¬ì ë¼ì´ì„ ìŠ¤ ê´€ë¦¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-button {
      @apply px-6 py-3 rounded-lg font-semibold transition-colors;
    }
    .tab-button.active {
      @apply bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg;
    }
    .tab-button:not(.active) {
      @apply bg-white text-gray-700 hover:bg-gray-100;
    }
    .tab-content {
      @apply hidden;
    }
    .tab-content.active {
      @apply block;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- í—¤ë” -->
  <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-8">
    <div class="container mx-auto px-4">
      <h1 class="text-3xl font-bold">ğŸ“Š ì—”ë³´ì„ í”Œë˜ë„ˆ í”„ë¡œ - ë¼ì´ì„ ìŠ¤ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
      <p class="mt-2">ê´€ë¦¬ì ì§ì ‘ ë°œê¸‰ ë° í†µí•© ê´€ë¦¬</p>
    </div>
  </div>

  <!-- ë©”ì¸ ì»¨í…ì¸  -->
  <div class="container mx-auto px-4 py-8">
    <!-- Tab Navigation -->
    <div class="flex flex-wrap gap-2 mb-6">
      <button id="tab-issue" class="tab-button active" onclick="switchTab('issue')">
        ë¼ì´ì„ ìŠ¤ ë°œê¸‰
      </button>
      <button id="tab-list" class="tab-button" onclick="switchTab('list')">
        ì „ì²´ ë¼ì´ì„ ìŠ¤
      </button>
      <button id="tab-manage" class="tab-button" onclick="switchTab('manage')">
        ë¼ì´ì„ ìŠ¤ ê´€ë¦¬
      </button>
      <button id="tab-usage" class="tab-button" onclick="switchTab('usage')">
        ì‚¬ìš© ë‚´ì—­
      </button>
    </div>

    <!-- Tab 1: ë¼ì´ì„ ìŠ¤ ë°œê¸‰ -->
    <div id="content-issue" class="tab-content active">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- ì™¼ìª½: ë¼ì´ì„ ìŠ¤ ë°œê¸‰ í¼ -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-2xl font-bold mb-6">ğŸ“ ë¼ì´ì„ ìŠ¤ ë°œê¸‰</h2>

          <form id="licenseForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ì‚¬ìš© ê¸°ê°„ (ì¼)</label>
              <input type="number" id="durationDays" min="1" max="365" value="30" required
                     class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ìµœëŒ€ í•™ìƒ ìˆ˜</label>
              <input type="number" id="maxStudents" min="1" max="100" value="10" required
                     class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ê³ ê° ì´ë¦„</label>
              <input type="text" id="customerName" placeholder="í™ê¸¸ë™" required
                     class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë©”ì¼ ì£¼ì†Œ *</label>
              <input type="email" id="customerEmail" placeholder="customer@example.com" required
                     class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ë°œê¸‰ ì‚¬ìœ  (ë©”ëª¨)</label>
              <textarea id="notes" rows="3" placeholder="ì˜ˆ: ì„œë¹„ìŠ¤ ë³´ìƒ 4ì¼, í•™ìƒ ìˆ˜ ì¦ê°€ ë“±"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
            </div>

            <button type="submit"
                    class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-lg font-bold hover:from-purple-700 hover:to-indigo-700">
              ğŸš€ ë¼ì´ì„ ìŠ¤ ë°œê¸‰ ë° ì´ë©”ì¼ ì „ì†¡
            </button>
          </form>

          <div id="resultMessage" class="mt-4 hidden"></div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì•ˆë‚´ -->
        <div class="space-y-6">
          <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold mb-4">ğŸ’¡ ì‚¬ìš© ì•ˆë‚´</h2>
            <ul class="space-y-2 text-sm text-gray-700">
              <li>â€¢ <strong>ì‚¬ìš© ê¸°ê°„</strong>: 1~365ì¼ ì‚¬ì´ì—ì„œ ììœ ë¡­ê²Œ ì„¤ì •</li>
              <li>â€¢ <strong>í•™ìƒ ìˆ˜</strong>: í”Œë˜ë„ˆê°€ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ í•™ìƒ ìˆ˜</li>
              <li>â€¢ <strong>ì´ë©”ì¼ ë°œì†¡</strong>: ë¼ì´ì„ ìŠ¤ ë°œê¸‰ ì¦‰ì‹œ ìë™ ë°œì†¡</li>
              <li>â€¢ <strong>í™œì„±í™” ë°©ë²•</strong>: ê³ ê°ì´ ì´ë©”ì¼ì—ì„œ ë¼ì´ì„ ìŠ¤ í‚¤ í™•ì¸ í›„ í™œì„±í™”</li>
            </ul>
          </div>

          <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 class="text-lg font-bold mb-2">ğŸ“‹ ì‚¬ìš© ì‚¬ë¡€</h3>
            <ul class="space-y-2 text-sm text-gray-700">
              <li>â€¢ í˜„ê¸ˆ/ë‹¤ë¥¸ ê³„ì¢Œ ì§ì ‘ ì…ê¸ˆ ì‹œ</li>
              <li>â€¢ ì„œë¹„ìŠ¤ ë³´ìƒ (ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë“±)</li>
              <li>â€¢ í•™ìƒ ìˆ˜ ì¦ê°€ (ì¼í•  ê³„ì‚°)</li>
              <li>â€¢ ë¬´ë£Œ ì²´í—˜ (1ì¼ ë‹¨ê¸°)</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab 2: ì „ì²´ ë¼ì´ì„ ìŠ¤ -->
    <div id="content-list" class="tab-content">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-6">ğŸ“‹ ì „ì²´ ë¼ì´ì„ ìŠ¤</h2>

        <!-- ê²€ìƒ‰ ë° í•„í„° -->
        <div class="flex flex-wrap gap-4 mb-6">
          <input type="text" id="search-licenses" placeholder="ë¼ì´ì„ ìŠ¤ í‚¤ ê²€ìƒ‰"
                 class="flex-1 min-w-[200px] px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
          <select id="filter-status" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
            <option value="">ì „ì²´ ìƒíƒœ</option>
            <option value="pending">ëŒ€ê¸°ì¤‘</option>
            <option value="active">í™œì„±</option>
            <option value="expired">ë§Œë£Œ</option>
            <option value="superseded">ëŒ€ì²´ë¨</option>
          </select>
          <button onclick="loadAllLicenses()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            ê²€ìƒ‰
          </button>
        </div>

        <!-- ë¼ì´ì„ ìŠ¤ í…Œì´ë¸” -->
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white border">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 border text-left">ë¼ì´ì„ ìŠ¤ í‚¤</th>
                <th class="px-4 py-2 border text-left">ìƒíƒœ</th>
                <th class="px-4 py-2 border text-left">ê¸°ê°„/í•™ìƒìˆ˜</th>
                <th class="px-4 py-2 border text-left">ë§Œë£Œì¼</th>
                <th class="px-4 py-2 border text-left">ë‚¨ì€ ì¼ìˆ˜</th>
                <th class="px-4 py-2 border text-left">ë””ë°”ì´ìŠ¤</th>
                <th class="px-4 py-2 border text-left">ë°œê¸‰ì¼</th>
              </tr>
            </thead>
            <tbody id="licenses-table-body">
              <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                  ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¼ì´ì„ ìŠ¤ ëª©ë¡ì„ ì¡°íšŒí•˜ì„¸ìš”
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div id="pagination" class="flex justify-center mt-6 gap-2"></div>
      </div>
    </div>

    <!-- Tab 3: ë¼ì´ì„ ìŠ¤ ê´€ë¦¬ -->
    <div id="content-manage" class="tab-content">
      <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-6">âš™ï¸ ë¼ì´ì„ ìŠ¤ ê´€ë¦¬</h2>

        <form id="manageForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ë¼ì´ì„ ìŠ¤ í‚¤</label>
            <input type="text" id="manage-license-key" placeholder="ì˜ˆ: 30D-15P-ABC123DEF456"
                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" required>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ì‘ì—… ì„ íƒ</label>
            <select id="manage-operation" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" required>
              <option value="">-- ì‘ì—… ì„ íƒ --</option>
              <option value="extend">ê¸°ê°„ ì—°ì¥</option>
              <option value="suspend">ë¼ì´ì„ ìŠ¤ ì •ì§€</option>
              <option value="reactivate">ë¼ì´ì„ ìŠ¤ í™œì„±í™”</option>
              <option value="update_students">í•™ìƒ ìˆ˜ ë³€ê²½</option>
              <option value="delete">ë¼ì´ì„ ìŠ¤ ì‚­ì œ (ìœ„í—˜)</option>
            </select>
          </div>

          <div id="operation-fields"></div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ì‘ì—… ì‚¬ìœ </label>
            <textarea id="manage-reason" rows="3" placeholder="ì‘ì—… ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                      class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" required></textarea>
          </div>

          <button type="submit"
                  class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700">
            ì‹¤í–‰
          </button>
        </form>

        <div id="manage-result" class="mt-4 hidden"></div>
      </div>
    </div>

    <!-- Tab 4: ì‚¬ìš© ë‚´ì—­ -->
    <div id="content-usage" class="tab-content">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-6">ğŸ“œ ë¼ì´ì„ ìŠ¤ ì‚¬ìš© ë‚´ì—­</h2>

        <!-- ë¼ì´ì„ ìŠ¤ í‚¤ ì…ë ¥ -->
        <div class="max-w-2xl mb-6">
          <div class="flex gap-4">
            <input type="text" id="usage-license-key" placeholder="ë¼ì´ì„ ìŠ¤ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                   class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
            <button onclick="loadUsageStats()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              ì¡°íšŒí•˜ê¸°
            </button>
          </div>
        </div>

        <!-- ë¼ì´ì„ ìŠ¤ ì •ë³´ ì¹´ë“œ -->
        <div id="usage-license-info" class="hidden mb-6"></div>

        <!-- ì‚¬ìš©ëŸ‰ í†µê³„ -->
        <div id="usage-stats" class="hidden mb-6"></div>

        <!-- ì¼ë³„ ì‚¬ìš© ë‚´ì—­ í…Œì´ë¸” -->
        <div id="usage-daily" class="hidden"></div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Global variables
    let currentPage = 1;
    let adminPassword = null;

    // Tab switching
    function switchTab(tabName) {
      // Hide all tabs and deactivate buttons
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

      // Show selected tab and activate button
      document.getElementById(`content-${tabName}`).classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // Load data when switching to list tab
      if (tabName === 'list') {
        loadAllLicenses();
      }
    }

    // Utility functions
    function getStatusColor(status) {
      const colors = {
        pending: 'bg-yellow-100 text-yellow-800',
        active: 'bg-green-100 text-green-800',
        expired: 'bg-red-100 text-red-800',
        superseded: 'bg-gray-100 text-gray-800'
      };
      return colors[status] || 'bg-gray-100';
    }

    function getStatusLabel(status) {
      const labels = {
        pending: 'ëŒ€ê¸°ì¤‘',
        active: 'í™œì„±',
        expired: 'ë§Œë£Œ',
        superseded: 'ëŒ€ì²´ë¨'
      };
      return labels[status] || status;
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('ko-KR');
    }

    // Password verification on load
    window.addEventListener('DOMContentLoaded', async () => {
      adminPassword = sessionStorage.getItem('adminPassword');

      if (!adminPassword) {
        adminPassword = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');

        if (!adminPassword) {
          alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
          window.location.href = '/';
          return;
        }

        try {
          const response = await fetch('/api/admin/verify-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: adminPassword })
          });

          if (!response.ok) {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
            window.location.href = '/';
            return;
          }

          sessionStorage.setItem('adminPassword', adminPassword);
        } catch (error) {
          console.error('ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì˜¤ë¥˜:', error);
          alert('ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          window.location.href = '/';
        }
      }
    });

    // Tab 1: License Issuance Form
    document.getElementById('licenseForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = {
        durationDays: parseInt(document.getElementById('durationDays').value),
        maxStudents: parseInt(document.getElementById('maxStudents').value),
        customerName: document.getElementById('customerName').value,
        customerEmail: document.getElementById('customerEmail').value,
        notes: document.getElementById('notes').value,
        sendEmail: true
      };

      const resultDiv = document.getElementById('resultMessage');
      resultDiv.className = 'mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg';
      resultDiv.textContent = 'ë¼ì´ì„ ìŠ¤ ë°œê¸‰ ì¤‘...';
      resultDiv.classList.remove('hidden');

      try {
        const response = await fetch('/api/admin/licenses/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Password': adminPassword
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok) {
          resultDiv.className = 'mt-4 p-4 bg-green-50 border border-green-200 rounded-lg';
          resultDiv.innerHTML = `
            <h3 class="font-bold text-green-800 mb-2">âœ… ë¼ì´ì„ ìŠ¤ ë°œê¸‰ ì„±ê³µ!</h3>
            <p class="text-sm text-green-700">ë¼ì´ì„ ìŠ¤ í‚¤: <strong>${result.license.license_key}</strong></p>
            <p class="text-sm text-green-700">ì´ë©”ì¼ ë°œì†¡: ${result.emailSent ? 'ì™„ë£Œ' : 'ì‹¤íŒ¨'}</p>
          `;
          document.getElementById('licenseForm').reset();
        } else {
          throw new Error(result.error || 'ë¼ì´ì„ ìŠ¤ ë°œê¸‰ ì‹¤íŒ¨');
        }
      } catch (error) {
        resultDiv.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg';
        resultDiv.innerHTML = `
          <h3 class="font-bold text-red-800 mb-2">âŒ ì˜¤ë¥˜ ë°œìƒ</h3>
          <p class="text-sm text-red-700">${error.message}</p>
        `;
      }
    });

    // Tab 2: Load All Licenses
    async function loadAllLicenses(page = 1) {
      const search = document.getElementById('search-licenses').value;
      const status = document.getElementById('filter-status').value;

      const params = new URLSearchParams({
        page: page,
        limit: 20,
        ...(search && { search }),
        ...(status && { status })
      });

      try {
        const response = await fetch(`/api/admin/licenses?${params}`, {
          headers: { 'X-Admin-Password': adminPassword }
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'ë¼ì´ì„ ìŠ¤ ì¡°íšŒ ì‹¤íŒ¨');
        }

        const tbody = document.getElementById('licenses-table-body');

        if (!data.licenses || data.licenses.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                ì¡°íšŒëœ ë¼ì´ì„ ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤
              </td>
            </tr>
          `;
        } else {
          tbody.innerHTML = data.licenses.map(license => `
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-2 border font-mono text-sm">${license.license_key}</td>
              <td class="px-4 py-2 border">
                <span class="px-2 py-1 rounded text-sm ${getStatusColor(license.status)}">
                  ${getStatusLabel(license.status)}
                </span>
              </td>
              <td class="px-4 py-2 border">${license.duration_days}ì¼ / ${license.max_students}ëª…</td>
              <td class="px-4 py-2 border">${formatDate(license.expires_at)}</td>
              <td class="px-4 py-2 border ${license.remaining_days && license.remaining_days < 7 ? 'text-red-600 font-bold' : ''}">
                ${license.remaining_days || '-'}ì¼
              </td>
              <td class="px-4 py-2 border">${license.device_count}/${license.max_devices || 2}</td>
              <td class="px-4 py-2 border">${formatDate(license.created_at)}</td>
            </tr>
          `).join('');
        }

        renderPagination(data.pagination);
        currentPage = page;

      } catch (error) {
        console.error('Load licenses error:', error);
        alert(error.message);
      }
    }

    function renderPagination(pagination) {
      const paginationDiv = document.getElementById('pagination');

      if (!pagination || pagination.totalPages <= 1) {
        paginationDiv.innerHTML = '';
        return;
      }

      const buttons = [];

      // Previous button
      if (pagination.page > 1) {
        buttons.push(`
          <button onclick="loadAllLicenses(${pagination.page - 1})"
                  class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
            ì´ì „
          </button>
        `);
      }

      // Page numbers
      for (let i = 1; i <= pagination.totalPages; i++) {
        if (i === pagination.page) {
          buttons.push(`
            <button class="px-4 py-2 bg-purple-600 text-white rounded">
              ${i}
            </button>
          `);
        } else {
          buttons.push(`
            <button onclick="loadAllLicenses(${i})"
                    class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
              ${i}
            </button>
          `);
        }
      }

      // Next button
      if (pagination.page < pagination.totalPages) {
        buttons.push(`
          <button onclick="loadAllLicenses(${pagination.page + 1})"
                  class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
            ë‹¤ìŒ
          </button>
        `);
      }

      paginationDiv.innerHTML = buttons.join('');
    }

    // Tab 3: License Management
    document.getElementById('manage-operation').addEventListener('change', (e) => {
      const operation = e.target.value;
      const fieldsDiv = document.getElementById('operation-fields');

      if (operation === 'extend') {
        fieldsDiv.innerHTML = `
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">ì—°ì¥ ì¼ìˆ˜</label>
            <input type="number" id="additional-days" min="1" max="365"
                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                   placeholder="ì˜ˆ: 30" required>
          </div>
        `;
      } else if (operation === 'update_students') {
        fieldsDiv.innerHTML = `
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">ìƒˆ í•™ìƒ ìˆ˜</label>
            <input type="number" id="new-max-students" min="1" max="100"
                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                   placeholder="ì˜ˆ: 20" required>
          </div>
        `;
      } else {
        fieldsDiv.innerHTML = '';
      }
    });

    document.getElementById('manageForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await executeLicenseOperation();
    });

    async function executeLicenseOperation() {
      const licenseKey = document.getElementById('manage-license-key').value;
      const operation = document.getElementById('manage-operation').value;
      const reason = document.getElementById('manage-reason').value;

      if (!licenseKey || !operation || !reason) {
        alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const body = { operation, reason };

      if (operation === 'extend') {
        const additionalDays = document.getElementById('additional-days');
        if (!additionalDays || !additionalDays.value) {
          alert('ì—°ì¥ ì¼ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        body.additional_days = parseInt(additionalDays.value);
      } else if (operation === 'update_students') {
        const newMaxStudents = document.getElementById('new-max-students');
        if (!newMaxStudents || !newMaxStudents.value) {
          alert('ìƒˆ í•™ìƒ ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        body.new_max_students = parseInt(newMaxStudents.value);
      }

      try {
        let response;

        if (operation === 'delete') {
          if (!confirm('ì •ë§ë¡œ ì´ ë¼ì´ì„ ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
            return;
          }

          response = await fetch(`/api/admin/licenses/${encodeURIComponent(licenseKey)}`, {
            method: 'DELETE',
            headers: {
              'X-Admin-Password': adminPassword,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reason })
          });
        } else {
          response = await fetch(`/api/admin/licenses/${encodeURIComponent(licenseKey)}`, {
            method: 'PATCH',
            headers: {
              'X-Admin-Password': adminPassword,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          });
        }

        const result = await response.json();
        showManageResult(result, response.ok);

      } catch (error) {
        console.error('License operation error:', error);
        showManageResult({ error: error.message }, false);
      }
    }

    function showManageResult(result, success) {
      const resultDiv = document.getElementById('manage-result');
      resultDiv.className = `mt-4 p-4 rounded-lg ${success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`;
      resultDiv.innerHTML = `
        <h3 class="font-bold ${success ? 'text-green-800' : 'text-red-800'} mb-2">
          ${success ? 'âœ… ì‘ì—… ì™„ë£Œ' : 'âŒ ì‘ì—… ì‹¤íŒ¨'}
        </h3>
        <p class="${success ? 'text-green-700' : 'text-red-700'}">${result.message || result.error}</p>
      `;
      resultDiv.classList.remove('hidden');

      if (success) {
        document.getElementById('manage-license-key').value = '';
        document.getElementById('manage-operation').value = '';
        document.getElementById('manage-reason').value = '';
        document.getElementById('operation-fields').innerHTML = '';
      }
    }

    // Tab 4: Usage Stats
    async function loadUsageStats() {
      const licenseKey = document.getElementById('usage-license-key').value;

      if (!licenseKey) {
        alert('ë¼ì´ì„ ìŠ¤ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const response = await fetch(`/api/admin/licenses/${encodeURIComponent(licenseKey)}/usage`, {
          headers: { 'X-Admin-Password': adminPassword }
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'ì¡°íšŒ ì‹¤íŒ¨');
        }

        // License info card
        const infoDiv = document.getElementById('usage-license-info');
        infoDiv.innerHTML = `
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-bold mb-4">ë¼ì´ì„ ìŠ¤ ì •ë³´</h3>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p class="text-sm text-gray-600">ë¼ì´ì„ ìŠ¤ í‚¤</p>
                <p class="font-mono font-bold">${data.license.license_key}</p>
              </div>
              <div>
                <p class="text-sm text-gray-600">ìƒíƒœ</p>
                <p class="font-bold">${getStatusLabel(data.license.status)}</p>
              </div>
              <div>
                <p class="text-sm text-gray-600">ê¸°ê°„ / í•™ìƒ ìˆ˜</p>
                <p>${data.license.duration_days}ì¼ / ${data.license.max_students}ëª…</p>
              </div>
              <div>
                <p class="text-sm text-gray-600">ë§Œë£Œì¼</p>
                <p>${formatDate(data.license.expires_at)}</p>
              </div>
            </div>
          </div>
        `;
        infoDiv.classList.remove('hidden');

        // Usage stats
        const statsDiv = document.getElementById('usage-stats');
        statsDiv.innerHTML = `
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-bold mb-4">ì‚¬ìš©ëŸ‰ ìš”ì•½</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="text-center">
                <p class="text-3xl font-bold text-blue-600">${data.usage.total_days_used}</p>
                <p class="text-sm text-gray-600">ì‚¬ìš© ì¼ìˆ˜</p>
              </div>
              <div class="text-center">
                <p class="text-3xl font-bold text-green-600">${data.usage.remaining_days}</p>
                <p class="text-sm text-gray-600">ë‚¨ì€ ì¼ìˆ˜</p>
              </div>
              <div class="text-center">
                <p class="text-3xl font-bold text-purple-600">${data.usage.devices.length}</p>
                <p class="text-sm text-gray-600">ë“±ë¡ ë””ë°”ì´ìŠ¤</p>
              </div>
              <div class="text-center">
                <p class="text-3xl font-bold text-orange-600">${data.usage.daily_stats.length}</p>
                <p class="text-sm text-gray-600">í™œë™ ì¼ìˆ˜</p>
              </div>
            </div>

            ${data.usage.devices.length > 0 ? `
              <div class="mt-6">
                <h4 class="font-bold mb-2">ë“±ë¡ëœ ë””ë°”ì´ìŠ¤</h4>
                ${data.usage.devices.map(device => `
                  <div class="flex justify-between items-center bg-gray-50 p-3 rounded mb-2">
                    <span class="font-mono text-sm">${device.fingerprint.substring(0, 16)}...</span>
                    <span class="text-sm text-gray-600">${formatDate(device.registered_at)}</span>
                  </div>
                `).join('')}
              </div>
            ` : '<p class="mt-4 text-gray-500">ë“±ë¡ëœ ë””ë°”ì´ìŠ¤ ì—†ìŒ</p>'}
          </div>
        `;
        statsDiv.classList.remove('hidden');

        // Daily usage table
        const dailyDiv = document.getElementById('usage-daily');
        dailyDiv.innerHTML = `
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-bold mb-4">ì¼ë³„ ì‚¬ìš© ë‚´ì—­ (ìµœê·¼ 30ì¼)</h3>
            <div class="overflow-x-auto">
              <table class="min-w-full border">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="px-4 py-2 border text-left">ë‚ ì§œ</th>
                    <th class="px-4 py-2 border text-center">í•™ìƒ ìˆ˜</th>
                    <th class="px-4 py-2 border text-center">ìˆ™ì œ ìˆ˜</th>
                    <th class="px-4 py-2 border text-center">ë©”ì‹œì§€ ìˆ˜</th>
                    <th class="px-4 py-2 border text-center">ì €ì¥ì†Œ (MB)</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.usage.daily_stats.length > 0 ? data.usage.daily_stats.map(stat => `
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-2 border">${stat.date}</td>
                      <td class="px-4 py-2 border text-center">${stat.student_count}</td>
                      <td class="px-4 py-2 border text-center">${stat.homework_count}</td>
                      <td class="px-4 py-2 border text-center">${stat.message_count}</td>
                      <td class="px-4 py-2 border text-center">${stat.storage_used_mb.toFixed(2)}</td>
                    </tr>
                  `).join('') : `
                    <tr>
                      <td colspan="5" class="px-4 py-2 border text-center text-gray-500">ì‚¬ìš© ë‚´ì—­ ì—†ìŒ</td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>
          </div>
        `;
        dailyDiv.classList.remove('hidden');

      } catch (error) {
        console.error('Load usage error:', error);
        alert(error.message);
      }
    }
  </script>
</body>
</html>
