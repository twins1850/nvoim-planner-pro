# 앤보임 플래너 프로 - AI 기반 학습 관리 시스템 구현 상태

## 📋 구현 완료 현황

### ✅ Phase 1: 수강 과정 이력 (100% 완료)

**구현 완료 항목**:
1. **데이터 페칭 로직** - `StudentDetailContent.tsx` 라인 192-231
   - `student_courses` 테이블에서 현재 과정 조회
   - `course_history` 테이블에서 과거 이력 조회
   - 자동으로 최신순 정렬

2. **UI 렌더링** - `StudentDetailContent.tsx` 라인 1148-1248
   - 현재 수강 중인 과정 표시 (라인 1155-1189)
   - 과거 이력 타임라인 (라인 1192-1247)
   - 완료/전환/중단 상태별 색상 구분
   - 플래너 메모 표시

3. **상태 처리**
   - 이력이 없을 때 안내 메시지
   - 로딩 상태 표시
   - 실시간 데이터 갱신

---

### ✅ Phase 2: AI 추천 과정 (100% 완료)

#### 2-1. DB 스키마 수정 ✅

**파일**: `/supabase/migrations/20260210_student_level_test_and_goals.sql`

추가된 필드:
- `level_test_image_url` - 레벨테스트 이미지 URL
- `level_test_date` - 테스트 날짜
- `goal_description` - 목표 상세 설명
- `goal_target_date` - 목표 달성 희망일
- `goal_category` - 목표 카테고리

인덱스:
- `idx_student_profiles_level_test` - 레벨테스트 조회 최적화
- `idx_student_profiles_goal_category` - 목표 카테고리 조회 최적화

#### 2-2. 학생 기본정보 UI ✅

**파일**: `StudentDetailContent.tsx` 라인 638-811

**레벨테스트 섹션** (라인 638-733):
- 이미지 업로드 (`lines 669-708`)
- 이미지 미리보기
- 업로드 날짜 자동 입력
- 삭제 기능

**학습 목표 섹션** (라인 736-811):
- 목표 카테고리 선택 (토익스피킹, 해외여행, 일상영어, 워킹홀리데이, 비즈니스영어, 유학준비, 기타)
- 목표 달성 희망 날짜
- 목표 상세 설명 (textarea)

#### 2-3. Storage 버킷 생성 ✅

**파일**: `/supabase/migrations/20260210_create_level_test_bucket.sql`

- 버킷 ID: `level-test-images`
- Public 접근 가능
- RLS 정책:
  - 플래너만 업로드/삭제 가능
  - 인증된 사용자 조회 가능
  - 본인 파일만 수정/삭제 가능

#### 2-4. AI 분석 API 엔드포인트 ✅

**파일**: `/apps/planner-web/src/app/api/courses/analyze-and-recommend/route.ts`

**구현된 기능**:
1. **학생 정보 조회** (라인 17-26)
2. **API 키 검증** (라인 29-41)
3. **API 키 복호화** (라인 44-57)
4. **OpenAI 클라이언트 초기화** (라인 60-62)
5. **레벨테스트 이미지 분석** (라인 65-111)
   - GPT-4o Vision API 사용
   - 레벨, 점수, 강점/약점 추출
6. **학습 이력 조회** (라인 114-119)
7. **AI 추천 생성** (라인 122-202)
   - GPT-4o 사용
   - JSON 형식 응답
   - 3개 추천 과정
   - 학습 계획
   - AI 인사이트
8. **DB 저장** (라인 205-235)
   - 기존 추천 비활성화
   - 새 추천 저장

**API 엔드포인트**:
- URL: `POST /api/courses/analyze-and-recommend`
- Body: `{ "studentId": "uuid" }`
- Response: `{ success, recommendations, learning_plan, ai_insights }`

#### 2-5. AI 추천 UI ✅

**파일**: `StudentDetailContent.tsx` 라인 1252-1368

**구현된 기능**:
- **AI 추천 생성 버튼** (라인 1260-1277)
  - 로딩 상태 표시
  - 레벨테스트 이미지 없을 때 비활성화
  - 안내 메시지 (라인 1279-1285)
- **추천 카드** (라인 1288-1328)
  - 우선순위 배지
  - 매칭률 표시
  - 과정명, 카테고리, 레벨, 기간
  - 추천 이유
  - 과정 추가 버튼
- **AI 분석 인사이트** (라인 1331-1367)
  - 강점 (초록색)
  - 개선 영역 (노란색)
  - 학습 방향 (파란색)

---

### ✅ Phase 3: API 키 설정 (100% 완료)

**상태**: 이미 완전히 구현됨!

**페이지**: `/apps/planner-web/src/app/settings/api-keys/page.tsx`

**기능**:
- OpenAI, Azure, Anthropic, Google, Custom API 키 관리
- AES-256-GCM 암호화
- 키 추가/삭제/활성화
- 발급 방법 상세 안내
- 보안 주의사항

**DB**: `planner_api_keys` 테이블
- 암호화된 키 저장
- RLS 정책으로 플래너별 격리

**Edge Function**: `manage-api-keys`
- 암호화/복호화 처리
- 환경변수 `API_KEY_ENCRYPTION_KEY` 사용

---

## 🎯 다음 단계

### Phase 4: 검증 및 테스트

#### 4-1. 마이그레이션 실행

```bash
# Supabase CLI로 마이그레이션 실행
cd /Users/twins/Downloads/nvoim-planer-pro
supabase db push

# 또는 Supabase Dashboard에서 수동 실행
```

**실행할 마이그레이션**:
1. `20260210_student_level_test_and_goals.sql` - student_profiles 테이블 업데이트
2. `20260210_create_level_test_bucket.sql` - Storage 버킷 생성

#### 4-2. 기능 테스트

**테스트 시나리오 1: 레벨테스트 업로드**
1. 학생 상세 페이지 → 기본 정보 탭
2. 수정 모드 진입
3. 레벨테스트 이미지 업로드
4. 이미지 표시 확인
5. 저장 후 반영 확인

**테스트 시나리오 2: 학습 목표 입력**
1. 목표 카테고리 선택
2. 목표 설명 입력
3. 목표 달성 날짜 선택
4. 저장 후 표시 확인

**테스트 시나리오 3: API 키 설정**
1. 설정 > API 키 페이지 이동
2. OpenAI API 키 추가
3. 키 목록에 표시 확인

**테스트 시나리오 4: AI 추천 생성**
1. 학습 기록 탭 이동
2. "AI 추천 생성" 버튼 클릭
3. 분석 진행 확인 (로딩 표시)
4. 3개 추천 카드 표시 확인
5. AI 인사이트 표시 확인

**테스트 시나리오 5: 수강 과정 이력**
1. 학습 기록 탭 확인
2. 현재 수강 과정 표시 확인
3. 과거 이력 타임라인 확인
4. 상태별 색상 구분 확인

#### 4-3. 엣지 케이스 테스트

- [ ] API 키 없이 AI 추천 시도 → 안내 메시지 표시
- [ ] 레벨테스트 이미지 없이 추천 시도 → 버튼 비활성화
- [ ] 대용량 이미지 업로드 (>20MB) → 오류 처리
- [ ] API 사용량 초과 → 오류 메시지 표시
- [ ] 네트워크 오류 → 재시도 또는 안내

---

## 📊 구현 완료율

| Phase | 완료율 | 상태 |
|-------|--------|------|
| Phase 1: 수강 과정 이력 | 100% | ✅ 완료 |
| Phase 2: AI 추천 과정 | 100% | ✅ 완료 |
| Phase 3: API 키 설정 | 100% | ✅ 완료 |
| Phase 4: 검증 및 테스트 | 0% | 🔄 대기 중 |

**전체 진행률**: 75% (3/4 단계 완료)

---

## 🔧 남은 작업

### 필수 작업
1. ✅ 마이그레이션 실행 (Supabase Dashboard 또는 CLI)
2. ⚠️ API 키 설정 (OpenAI API 키 발급 및 등록)
3. 🧪 기능 테스트 (모든 시나리오)
4. 🐛 버그 수정 (테스트 중 발견된 이슈)

### 선택 작업
- 음성 분석 기능 (P2)
- 진도 추적 자동화 (P2)
- 학습 성과 대시보드 (P2)
- 학생 앱 연동 (P2)

---

## 💡 사용 방법

### 1. API 키 설정

**OpenAI API 키 발급**:
1. https://platform.openai.com/api-keys 접속
2. "Create new secret key" 클릭
3. 키 이름 입력 (예: "NVOIM Planner")
4. 생성된 키 복사 (sk-...로 시작)

**앤보임 플래너에 등록**:
1. 설정 > API 키 페이지 이동
2. "새 키 추가" 버튼 클릭
3. API 제공자: OpenAI 선택
4. 키 이름: "내 OpenAI 키"
5. API 키: 복사한 키 붙여넣기
6. 저장

### 2. 레벨테스트 업로드

1. 학생 상세 페이지 → 기본 정보 탭
2. "수정" 버튼 클릭
3. "레벨테스트 정보" 섹션 찾기
4. 이미지 파일 선택 (JPG, PNG)
5. "저장" 버튼 클릭

### 3. 학습 목표 입력

1. 기본 정보 탭 → "학습 목표" 섹션
2. 목표 카테고리 선택
3. 목표 달성 희망 날짜 선택
4. 목표 상세 설명 입력
5. 저장

### 4. AI 추천 생성

1. 학습 기록 탭 이동
2. "AI 추천 생성" 버튼 클릭
3. 분석 완료 대기 (약 5-10초)
4. 3개 추천 과정 확인
5. AI 인사이트 확인

---

## 🔒 보안 고려사항

### API 키 보안
- ✅ AES-256-GCM 암호화
- ✅ RLS 정책으로 플래너별 격리
- ⚠️ 환경변수 `API_KEY_ENCRYPTION_KEY` 안전 관리 필수

### 이미지 보안
- Storage 버킷은 public이지만 URL 예측 불가
- RLS 정책으로 업로드/삭제 권한 제한
- 개인정보 포함 가능하므로 주의

### 데이터 프라이버시
- 레벨테스트 결과는 민감 정보
- 학생 목표는 개인정보
- RLS 정책 철저히 적용

---

## 📈 예상 비용

### OpenAI API 사용 비용
- **Vision API**: 이미지 분석 1회당 약 1000 토큰
- **GPT-4o**: 추천 생성 약 1500-2000 토큰
- **예상 비용**: 1회 추천당 $0.05-0.10
- **월 예상**: 학생 30명 기준 $1.50-$3.00

### 최적화 방안
- 레벨테스트 결과는 변경되지 않으므로 재분석 불필요
- 목표 변경 시에만 재추천
- `expires_at` 필드로 30일 후 자동 만료
- 캐싱으로 중복 분석 방지

---

## 🎯 비즈니스 가치

### 차별화 포인트
- 앤보임 플랫폼의 레벨테스트는 레벨별로 동일한 추천 제공
- **차별화**: 레벨테스트 결과 + 학생 목표를 AI가 분석하여 **개인화된 맞춤 추천** 제공
- 유료 플랜 사용의 정당성 확보
- 플래너의 업무 효율성 극대화

### 기대 효과
- 학생 만족도 향상 (개인 맞춤형 추천)
- 플래너 업무 시간 단축 (AI 자동 분석)
- 과정 등록률 증가 (적합한 과정 추천)
- 유료 플랜 전환율 향상

---

## 📞 문의

구현 관련 문의사항이나 버그 리포트는 GitHub Issues에 등록해주세요.
